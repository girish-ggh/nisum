trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  AZURE_WEBAPP_NAME: 'Nisum'          # The name of your Azure Web App
  AZURE_RESOURCE_GROUP: 'Drupal'   # Your Resource Group
  AZURE_SERVICE_CONNECTION: 'NisumAzureConnection' # Your Service Connection

steps:
  - script: |
      echo "Installing PHP 8.3..."
      sudo apt-get update
      sudo apt-get install -y php8.3 php8.3-cli php8.3-mbstring php8.3-xml
    displayName: 'Install PHP 8.3'

  - script: |
      php --version
    displayName: 'Check PHP Version'

  - task: DownloadPipelineArtifact@2
    inputs:
      artifact: 'drop'

  - task: Bash@3
    inputs:
      targetType: 'inline'
      script: |
        echo "Installing Composer dependencies..."
        composer install --no-interaction --prefer-dist --optimize-autoloader

  - task: AzureWebApp@1
    inputs:
      azureSubscription: $(AZURE_SERVICE_CONNECTION)
      appName: $(AZURE_WEBAPP_NAME)
      resourceGroupName: $(AZURE_RESOURCE_GROUP)
      package: $(Pipeline.Workspace)/drop
